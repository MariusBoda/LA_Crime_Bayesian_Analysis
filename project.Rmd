```{r}
install.packages(c("brms", "rstan", "tidyverse", "sf"))
install.packages("ggplot2")
install.packages("sf")
install.packages("osmdata")
```

```{r}
library(brms)
library(rstan)
library(tidyverse)
library(sf)
library(ggplot2)
library(osmdata)
```

```{r}
crime_data <- read.csv("Data - Sheet2.csv")
```

```{r}
crime_data <- crime_data %>%
  mutate(
    # Apply thematic grouping directly
    Premis_Group = case_when(
      grepl("SINGLE FAMILY DWELLING|MULTI-UNIT DWELLING|CONDOMINIUM|TOWNHOUSE|GARAGE|GROUP HOME|SRO|PORCH, RESIDENTIAL|HIGH-RISE BUILDING|FRAT HOUSE/SORORITY/DORMITORY", Premis.Desc, ignore.case = TRUE) ~ "Residential",
      grepl("DEPARTMENT STORE|MARKET|MINI-MART|DRUG STORE|BEAUTY SUPPLY STORE|LIQUOR STORE|TOBACCO SHOP|CLOTHING STORE|JEWELRY STORE|OTHER STORE|BAR|RESTAURANT|COFFEE SHOP|NIGHT CLUB|SPORTS BAR|HOTEL|OFFICE BUILDING/OFFICE|GAS STATION|LAUNDROMAT|HEALTH SPA/GYM|NAIL SALON|PUBLIC STORAGE|FURNITURE STORE|BANK", Premis.Desc, ignore.case = TRUE) ~ "Commercial",
      grepl("STREET|SIDEWALK|PARKING LOT|PARKING UNDERGROUND|ALLEY|DRIVEWAY|PUBLIC RESTROOM|PARK|MTA|BUS|VEHICLE|LA UNION STATION|CONSTRUCTION SITE|TOW YARD|COLLEGE/JUNIOR COLLEGE/UNIVERSITY|ABANDONED BUILDING ABANDONED HOUSE|CONVENTION CENTER|AMTRAK TRAIN|SHOPPING MALL (COMMON AREA)", Premis.Desc, ignore.case = TRUE) ~ "Public Spaces",
      grepl("HOSPITAL|MEDICAL/DENTAL OFFICES|NURSING|RETIREMENT HOME", Premis.Desc, ignore.case = TRUE) ~ "Healthcare",
      grepl("POLICE FACILITY|GOVERNMENT FACILITY|LIBRARY|MISSIONS/SHELTERS|DETENTION|JAIL|STAPLES CENTER", Premis.Desc, ignore.case = TRUE) ~ "Government",
      TRUE ~ "Other"
    ),
  
    # Convert DATE_OCC to Date
    DATE_OCC = as.Date(DATE_OCC, format = "%m/%d/%Y"),
    
    # Create 'day_of_week' factor
    day_of_week = factor(weekdays(DATE_OCC), levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
    
    # 'has_weapon' flag
    has_weapon = ifelse(!is.na(Weapon.Used.Cd), 1, 0),
    
    # Extract hour and minute from TIME_OCC
    hour = floor(TIME.OCC / 100),
    minute = TIME.OCC %% 100,
    time_of_day = hour + minute / 60
  ) %>%
  # Convert AREA_NAME and Premis_Group to factors
  mutate(
    AREA_NAME = as.factor(AREA.NAME),
    Premis_Group = as.factor(Premis_Group),
    Vict.Sex = as.factor(Vict.Sex),
    Vict.Descent = as.factor(Vict.Descent)
    
  )
```

```{r}
crime_data <- crime_data %>%
  mutate(
    time_of_day_category = case_when(
      hour >= 6 & hour < 12 ~ "Morning",
      hour >= 12 & hour < 18 ~ "Afternoon",
      hour >= 18 & hour < 22 ~ "Evening",
      TRUE ~ "Night"
    )
  )
```

```{r}
# Combine rare area names into "Other" category
crime_data$`AREA_NAME` <- fct_lump(crime_data$`AREA_NAME`, n = 10)  # Keep the 10 most common areas
crime_data$`AREA_NAME` <- factor(crime_data$`AREA_NAME`)  # Relevel the factor
```

```{r}
crime_data$day_type <- ifelse(crime_data$day_of_week %in% c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday"), "Weekday", "Weekend")
```

```{r}
crime_data$area_type <- case_when(
  crime_data$AREA_NAME %in% c("Hollywood", "Rampart", "Central") ~ "High Crime",
  crime_data$AREA_NAME %in% c("Van Nuys", "West Valley", "Southwest", "Harbor") ~ "Low Crime",
  TRUE ~ "Other"
)
```

```{r}
head(crime_data)
```

```{r}
# Define priors
prior_intercept <- prior(normal(0, 5), class = "Intercept")
prior_vict_age <- prior(normal(0, 2), class = "b", coef = "Vict.Age")

model <- brm(
  formula = has_weapon ~ Vict.Age + day_type + time_of_day_category + Premis_Group,
  family = bernoulli(link = "logit"),
  data = crime_data,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  thin = 1,
  prior = c(prior_intercept, prior_vict_age)  # No priors for factors needed here
)

# Check the model summary
summary(model)
```

```{r}
# Posterior summary for all parameters
posterior_summary <- summary(model)$fixed
print(posterior_summary)

# Alternatively, use the `posterior` package to extract posterior samples:
library(posterior)
posterior_samples <- as.array(model)
```

```{r}
# Posterior predictive checks (to assess fit)
pp_check(model)
```

```{r}
# Plot the conditional effects of day_type and time_of_day_category
conditional_effects(model)
```

```{r}
# Hierarchical model with random intercepts and random slopes for area_type
model_hierarchical <- brm(
  formula = has_weapon ~ Vict.Age + day_type + time_of_day_category + (1 | area_type) + Premis_Group,
  family = bernoulli(link = "logit"),
  data = crime_data,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  thin = 1,
  prior = c(prior_intercept, prior_vict_age)
)

# Check the model summary
summary(model_hierarchical)
```

```{r}
# Posterior predictive checks (to assess fit)
pp_check(model_hierarchical)
```

```{r}
# Plot the conditional effects of day_type and time_of_day_category
conditional_effects(model_hierarchical)
```

```{r}
loo(model)
loo(model_hierarchical)
```

```{r}
# Define a smaller bounding box for Downtown Los Angeles
bbox <- c(left = -118.2700, bottom = 34.0400, right = -118.2200, top = 34.0700)

# Get the OpenStreetMap data for the smaller area
la_map_osm <- opq(bbox) %>%
  osmdata_sf()

# Convert the dataframe to an sf object
df_sf <- st_as_sf(crime_data, coords = c("LON", "LAT"), crs = 4326)  # EPSG:4326 for WGS 84

# Create a map with the OpenStreetMap background and crime data points
# Display plot directly in RStudio's plot window
ggplot(data = df_sf) + 
  geom_sf(aes(fill = "blue"),  # Fill color for dots
          color = "black",     # Outline color
          size = 2) +          # Size of dots
  theme_minimal() + 
  ggtitle("Map of Data in Los Angeles") +
  theme(legend.position = "none")  # Optional: remove legend
```

```{r}
install.packages("leaflet")
library(leaflet)

leaflet(data = crime_data) %>%
  addTiles() %>%
  addCircleMarkers(
    ~LON, ~LAT,
    radius = 5,
    color = "red",
    popup = ~paste("Crime Code: ", Crm.Cd)
  ) %>%
  setView(lng = -118.245, lat = 34.055, zoom = 14)
```
